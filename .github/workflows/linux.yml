name: Linux

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  linux-build:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        cxx_compiler: [ clang++, g++-10 ]
        c_compiler: [ clang, gcc-10 ]
        sanitizer: [ "address,undefined", "thread", "" ]
        exclude:
          - cxx_compiler: clang++
            c_compiler: gcc-10
          - cxx_compiler: g++-10
            c_compiler: clang
          - cxx_compiler: g++-10
            sanitizer: "address,undefined"
          - cxx_compiler: g++-10
            sanitizer: "thread"

    steps:

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install libunwind-dev g++-10 lld

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9

      - name: Install Ninja
        uses: ashutoshvarma/setup-ninja@v1.1

      - name: Checkout Pylir
        uses: actions/checkout@v3
        with:
          path: Pylir

      - name: Install Python depends
        run: |
          python -m pip install -r ${{github.workspace}}/Pylir/test/requirements.txt

      # See https://github.com/actions/cache/issues/53
      - name: Sanitize key
        id: sanitize-key
        run: echo "::set-output name=key::$(echo ${{matrix.sanitizer}} | sed 's/,/_and_/g')"

      - name: Install CCache
        uses: hendrikmuhs/ccache-action@v1.2.2
        with:
          max-size: 2G
          key: ${{runner.os}}-${{steps.sanitize-key.outputs.key}}-${{matrix.cxx_compiler}}

      - name: Checkout LLVM
        uses: ./Pylir/.github/actions/llvm-checkout

      - name: Configure LLVM Optimized TableGen
        run: |
          cmake -GNinja -Bllvm-optimized-tblgen \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=${{matrix.cxx_compiler}} \
            -DCMAKE_C_COMPILER=${{matrix.c_compiler}} \
            -DLLVM_CCACHE_BUILD=ON \
            -DLLVM_ENABLE_PROJECTS="mlir" \
            -DLLVM_TARGETS_TO_BUILD=host \
            -DLLVM_ENABLE_LLD=ON \
            -DPython3_EXECUTABLE="$(which python)" \
            -S ${{github.workspace}}/llvm-project/llvm

      - name: Build LLVM Optimized TableGen
        run: |
          cmake --build llvm-optimized-tblgen --target mlir-tblgen llvm-tblgen mlir-linalg-ods-yaml-gen

      - name: Sanitizers name to LLVM
        id: sanitize-llvm-name
        run: |
          echo "::set-output name=llvm_sanitizer::$(echo ${{matrix.sanitizer}} |\
          sed 's/,/;/g' |\
          python3 -c 'import sys; print(sys.stdin.read().title())' )"

      - name: Configure LLVM
        run: |
          export SAN_ARG=$(echo "${{matrix.sanitizer}}" | \
            sed 's/,/;/g' | \
          python3 -c 'import sys; print("\"-DLLVM_USE_SANITIZER=\"" + arg.title() + "\"") if len(arg := sys.stdin.read()) != 0 else print()')
          cmake -GNinja -Bllvm-build \
            -DLLVM_TABLEGEN="${{github.workspace}}/llvm-optimized-tblgen/bin/llvm-tblgen" \
            -DMLIR_TABLEGEN="${{github.workspace}}/llvm-optimized-tblgen/bin/mlir-tblgen" \
            -DMLIR_LINALG_ODS_YAML_GEN="${{github.workspace}}/llvm-optimized-tblgen/bin/mlir-linalg-ods-yaml-gen" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=${{matrix.cxx_compiler}} \
            -DCMAKE_C_COMPILER=${{matrix.c_compiler}} \
            -DLLVM_CCACHE_BUILD=ON \
            -DLLVM_ENABLE_ASSERTIONS=ON \
            -DLLVM_ENABLE_PROJECTS="mlir;lld" \
            -DLLVM_TARGETS_TO_BUILD=host \
            -DLLVM_ENABLE_LLD=ON \
            -DPython3_EXECUTABLE="$(which python)" \
            $SAN_ARG \
            -S ${{github.workspace}}/llvm-project/llvm

      - name: Build LLVM
        run: |
          cmake --build llvm-build

      - name: Configure Pylir
        run: |
          export SAN_ARG=$(echo "${{matrix.sanitizer}}" | \
          python3 -c 'import sys; print("\"-DPYLIR_SANITIZER=\"" + arg + "\"") if len(arg := sys.stdin.read()) != 0 else print()')
          cmake -GNinja -Bpylir-build \
            -DCMAKE_BUILD_TYPE=Release \
            -DPYLIR_EMBED_LLD=ON \
            -DCMAKE_CXX_COMPILER=${{matrix.cxx_compiler}} \
            -DCMAKE_C_COMPILER=${{matrix.c_compiler}} \
            -DPYLIR_SANITIZER=${{matrix.sanitizer}} \
            -DPython3_EXECUTABLE="$(which python)" \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_EXE_LINKER_FLAGS="-fuse-ld=lld" \
            -DCMAKE_CXX_FLAGS="-g1" \
            -DPYLIR_ENABLE_ASSERTIONS=ON \
            -DLLVM_DIR="${{github.workspace}}/llvm-build/lib/cmake/llvm/" \
            -DMLIR_DIR="${{github.workspace}}/llvm-build/lib/cmake/mlir/" \
            -DLLD_DIR="${{github.workspace}}/llvm-build/lib/cmake/lld/" \
            -S ${{github.workspace}}/Pylir

      - name: Build Pylir
        run: |
          cmake --build pylir-build

      - name: Test
        working-directory: ${{github.workspace}}/pylir-build
        run: ctest --extra-verbose

